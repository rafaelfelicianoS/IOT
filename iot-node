#!/bin/bash
# Wrapper script para iot-node com auto-detecção de certificados

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CERTS_DIR="$SCRIPT_DIR/certs"

# Ativar venv se existir
if [ -f "$SCRIPT_DIR/venv/bin/activate" ]; then
    source "$SCRIPT_DIR/venv/bin/activate"
fi

# Auto-detectar certificados
echo "============================================================"
echo "  Iniciando IoT Node Device (Interactive Mode)"
echo "============================================================"
echo ""

# Procurar certificado CA
CA_CERT="$CERTS_DIR/ca_certificate.pem"
if [ ! -f "$CA_CERT" ]; then
    echo " Certificado CA não encontrado: $CA_CERT"
    exit 1
fi

# Procurar certificados de Node
NODE_CERTS=()
NODE_KEYS=()

# Procurar formato antigo
for cert in "$CERTS_DIR"/node_*_cert.pem; do
    [ -f "$cert" ] || continue
    basename=$(basename "$cert" _cert.pem)
    key="$CERTS_DIR/${basename}_key.pem"
    if [ -f "$key" ]; then
        NODE_CERTS+=("$cert")
        NODE_KEYS+=("$key")
    fi
done

# Procurar formato novo (UUID directories)
for dir in "$CERTS_DIR"/*/; do
    [ -d "$dir" ] || continue
    cert="$dir/certificate.pem"
    key="$dir/private_key.pem"
    if [ -f "$cert" ] && [ -f "$key" ]; then
        # Verificar se não é Sink (tem "Sink" no subject)
        if ! openssl x509 -in "$cert" -noout -subject 2>/dev/null | grep -q "Sink"; then
            NODE_CERTS+=("$cert")
            NODE_KEYS+=("$key")
        fi
    fi
done

# Verificar se encontrou certificados
if [ ${#NODE_CERTS[@]} -eq 0 ]; then
    echo " Nenhum certificado de Node encontrado em $CERTS_DIR/"
    echo "   Esperado: node_*_cert.pem ou <UUID>/certificate.pem"
    echo ""
    echo "Crie um certificado com:"
    echo "   python -m support.provision_device --nid \$(uuidgen) --type node"
    exit 1
fi

# Se houver múltiplos, mostrar e usar o primeiro
CERT_INDEX=0
if [ ${#NODE_CERTS[@]} -gt 1 ]; then
    echo ""
    echo "AVISO: Múltiplos certificados Node encontrados:"
    for i in "${!NODE_CERTS[@]}"; do
        basename=$(basename "${NODE_CERTS[$i]}")
        echo "  $((i+1)). $basename"
    done
    echo ""
    echo "Usando o primeiro: $(basename "${NODE_CERTS[0]}")"
    echo "(Use --cert e --key para escolher outro)"
    echo ""
fi

SELECTED_CERT="${NODE_CERTS[$CERT_INDEX]}"
SELECTED_KEY="${NODE_KEYS[$CERT_INDEX]}"

echo " Certificados encontrados:"
echo "   Cert: $SELECTED_CERT"
echo "   Key:  $SELECTED_KEY"
echo "   CA:   $CA_CERT"
echo ""

# Filtrar argumentos - remover "interactive" se for o primeiro argumento
EXTRA_ARGS=()
if [ "$1" != "interactive" ]; then
    EXTRA_ARGS=("$@")
fi

# Executar o Node interativo
exec python3 "$SCRIPT_DIR/node/interactive_node.py" \
    --cert "$SELECTED_CERT" \
    --key "$SELECTED_KEY" \
    --ca-cert "$CA_CERT" \
    "${EXTRA_ARGS[@]}"
